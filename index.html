<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞–Ω–∏–π</title>
  <style>
    :root {
      --bg: #ffffff;
      --text: #111111;
      --btn-bg: #f2f2f2;
      --btn-text: #111111;
      --btn-border: #d0d0d0;
      --accent: #4caf50;
    }
    .dark {
      --bg: #000000;
      --text: #f5f5f5;
      --btn-bg: #1f1f1f;
      --btn-text: #f5f5f5;
      --btn-border: #333333;
      --accent: #66bb6a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s, color 0.3s;
    }
    .theme-toggle {
      position: fixed; top: 12px; right: 12px;
      padding: 8px 12px;
      background: var(--btn-bg); color: var(--btn-text);
      border: 1px solid var(--btn-border);
      border-radius: 6px; cursor: pointer;
    }
    h1 { margin: 60px 20px 10px; }
    .controls {
      display: flex; gap: 12px; align-items: center;
      margin: 0 20px 10px; flex-wrap: wrap;
    }
    .group {
      display: flex; gap: 8px; align-items: center;
    }
    .group button, .group select {
      padding: 6px 10px;
      border: 1px solid var(--btn-border); border-radius: 4px;
      background: var(--btn-bg); color: var(--btn-text); cursor: pointer;
    }
    .group button.active, .group select.active { outline: 2px solid #888; }
    .progress-wrap { width: calc(100% - 40px); margin: 0 20px 10px; }
    .progress-bar {
      height: 12px; background: #bbb; border-radius: 6px; overflow: hidden;
    }
    .progress-fill {
      height: 100%; background: var(--accent); width: 0%; transition: width 0.3s;
    }
    .progress-text { margin-top: 6px; font-weight: 600; }
    .add-task {
      display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto;
      gap: 10px; margin: 20px;
    }
    .add-task input, .add-task select, .add-task button {
      padding: 8px; border: 1px solid var(--btn-border);
      border-radius: 4px; background: var(--bg); color: var(--text);
    }
    .add-task button { cursor: pointer; }
    ul { list-style: none; padding: 0 20px; margin: 0; }
    li {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px; margin-bottom: 8px;
      border: 1px solid var(--btn-border); border-radius: 6px;
      background: var(--btn-bg); color: var(--btn-text);
      transition: transform 0.2s, background 0.3s, border-color 0.2s;
    }
    li:hover { transform: scale(1.01); background: rgba(127,127,127,0.08); }
    .content { display: grid; gap: 4px; flex: 1; min-width: 0; }
    .title {
      font-weight: 600; cursor: text; word-wrap: break-word; overflow-wrap: anywhere;
    }
    .title.editing input {
      width: 100%; padding: 6px 8px; border: 1px solid var(--btn-border);
      border-radius: 4px; background: var(--bg); color: var(--text);
    }
    .meta { font-size: 0.9em; opacity: 0.85; display: flex; gap: 10px; flex-wrap: wrap; }
    .done .title { text-decoration: line-through; opacity: 0.6; }
    .actions { display: flex; gap: 8px; }
    .btn {
      padding: 6px 10px; border: 1px solid var(--btn-border);
      border-radius: 4px; background: var(--bg); color: var(--text); cursor: pointer;
    }
    .delete-btn { background: crimson; color: #fff; border: none; }
    .priority-low { color: #2e7d32; }
    .priority-medium { color: #f9a825; }
    .priority-high { color: #d32f2f; font-weight: 600; }
    .overdue { border-color: #d32f2f; }
    .badge {
      padding: 2px 6px; border: 1px solid var(--btn-border);
      border-radius: 999px; background: var(--bg);
    }
  </style>
</head>
<body>
  <button class="theme-toggle" id="themeToggle">üåû –°–≤–µ—Ç–ª–∞—è</button>

  <h1>–ú–æ–π —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞–Ω–∏–π</h1>

  <div class="controls">
    <div class="group filters">
      <button data-filter="all" class="active">–í—Å–µ</button>
      <button data-filter="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
      <button data-filter="done">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
      <select id="categoryFilter">
        <option value="all">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
        <option value="–£—á—ë–±–∞">–£—á—ë–±–∞</option>
        <option value="–†–∞–±–æ—Ç–∞">–†–∞–±–æ—Ç–∞</option>
        <option value="–õ–∏—á–Ω–æ–µ">–õ–∏—á–Ω–æ–µ</option>
      </select>
    </div>
    <div class="group sorts">
      <button data-sort="none" class="active">–ë–µ–∑ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</button>
      <button data-sort="priority">–ü–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É</button>
      <button data-sort="deadline">–ü–æ –¥–µ–¥–ª–∞–π–Ω—É</button>
    </div>
  </div>

  <div class="progress-wrap">
    <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
    <div id="progressText" class="progress-text">‚úÖ 0 / 0</div>
  </div>

  <form class="add-task" id="addTaskForm">
    <input type="text" id="taskInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ..." />
    <input type="date" id="taskDate" />
    <select id="taskPriority">
      <option value="low">–ù–∏–∑–∫–∏–π</option>
      <option value="medium" selected>–°—Ä–µ–¥–Ω–∏–π</option>
      <option value="high">–í—ã—Å–æ–∫–∏–π</option>
    </select>
    <select id="taskCategory">
      <option value="–£—á—ë–±–∞">–£—á—ë–±–∞</option>
      <option value="–†–∞–±–æ—Ç–∞">–†–∞–±–æ—Ç–∞</option>
      <option value="–õ–∏—á–Ω–æ–µ">–õ–∏—á–Ω–æ–µ</option>
    </select>
    <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
  </form>

  <ul id="taskList"></ul>

  <script>
    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const root = document.documentElement;
    const themeBtn = document.getElementById('themeToggle');
    const taskList = document.getElementById('taskList');
    const form = document.getElementById('addTaskForm');
    const input = document.getElementById('taskInput');
    const dateInput = document.getElementById('taskDate');
    const priorityInput = document.getElementById('taskPriority');
    const categoryInput = document.getElementById('taskCategory');
    const filterButtons = document.querySelectorAll('.filters button');
    const categoryFilter = document.getElementById('categoryFilter');
    const sortButtons = document.querySelectorAll('.sorts button');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ
    let currentFilter = 'all';     // all | active | done
    let currentCategory = 'all';   // all | –£—á—ë–±–∞ | –†–∞–±–æ—Ç–∞ | –õ–∏—á–Ω–æ–µ
    let currentSort = 'none';      // none | priority | deadline
    let tasks = loadTasks();

    // --- –¢–µ–º–∞ ---
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) root.classList.toggle('dark', savedTheme === 'dark');
    updateThemeButton();
    themeBtn.addEventListener('click', () => {
      root.classList.toggle('dark');
      localStorage.setItem('theme', root.classList.contains('dark') ? 'dark' : 'light');
      updateThemeButton();
    });
    function updateThemeButton() {
      themeBtn.textContent = root.classList.contains('dark') ? 'üåô –¢—ë–º–Ω–∞—è' : 'üåû –°–≤–µ—Ç–ª–∞—è';
    }

    // --- –•—Ä–∞–Ω–∏–ª–∏—â–µ ---
    function loadTasks() {
      try {
        const arr = JSON.parse(localStorage.getItem('tasks')) || [];
        return arr.map(t => ({
          id: t.id || genId(),
          text: typeof t.text === 'string' ? t.text : '',
          done: !!t.done,
          deadline: t.deadline || null,
          priority: t.priority || 'medium',
          category: t.category || '–õ–∏—á–Ω–æ–µ'
        }));
      } catch {
        return [];
      }
    }
    function saveTasks() {
      localStorage.setItem('tasks', JSON.stringify(tasks));
    }
    function genId() {
      return `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
    }

    // --- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è) ---
    if ('Notification' in window) {
      if (Notification.permission === 'default') {
        Notification.requestPermission().catch(() => {});
      }
      notifyTodayTasks();
    }
    function notifyTodayTasks() {
      if (Notification.permission !== 'granted') return;
      const today = isoToday();
      const dueToday = tasks.filter(t => t.deadline === today && !t.done);
      if (dueToday.length > 0) {
        new Notification('–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –∑–∞–¥–∞—á–∞—Ö', {
          body: `–ù–∞ —Å–µ–≥–æ–¥–Ω—è: ${dueToday.map(t => t.text).join(', ')}`,
        });
      }
    }

    // --- –†–µ–Ω–¥–µ—Ä ---
    function renderTasks() {
      taskList.innerHTML = '';

      let filtered = tasks.filter(t => {
        if (currentFilter === 'active' && t.done) return false;
        if (currentFilter === 'done' && !t.done) return false;
        if (currentCategory !== 'all' && t.category !== currentCategory) return false;
        return true;
      });

      if (currentSort === 'priority') {
        const order = { high: 1, medium: 2, low: 3 };
        filtered.sort((a, b) => order[a.priority] - order[b.priority]);
      } else if (currentSort === 'deadline') {
        filtered.sort((a, b) => (a.deadline || '9999-12-31').localeCompare(b.deadline || '9999-12-31'));
      }

      const today = isoToday();

      filtered.forEach(task => {
        const li = document.createElement('li');
        if (task.done) li.classList.add('done');
        if (task.deadline && task.deadline < today && !task.done) li.classList.add('overdue');

        const content = document.createElement('div');
        content.className = 'content';

        // –ó–∞–≥–æ–ª–æ–≤–æ–∫ ‚Äî –∏–Ω–ª–∞–π–Ω‚Äë—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        const title = document.createElement('div');
        title.className = 'title';
        title.textContent = task.text || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)';
        title.addEventListener('click', () => startInlineEdit(title, task.id));

        const meta = document.createElement('div');
        meta.className = 'meta';
        const priorityLabel = labelPriority(task.priority);
        const deadlineLabel = task.deadline ? `–¥–æ ${task.deadline}` : '–±–µ–∑ –¥–µ–¥–ª–∞–π–Ω–∞';
        const categoryLabel = `–∫–∞—Ç–µ–≥–æ—Ä–∏—è: ${task.category}`;
        const prioritySpan = document.createElement('span');
        prioritySpan.className = `priority-${task.priority}`;
        prioritySpan.textContent = `–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${priorityLabel}`;
        const deadlineSpan = document.createElement('span');
        deadlineSpan.textContent = deadlineLabel;
        const catSpan = document.createElement('span');
        catSpan.className = 'badge';
        catSpan.textContent = categoryLabel;
        meta.appendChild(prioritySpan);
        meta.appendChild(deadlineSpan);
        meta.appendChild(catSpan);

        content.appendChild(title);
        content.appendChild(meta);

        const actions = document.createElement('div');
        actions.className = 'actions';

        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'btn';
        toggleBtn.type = 'button';
        toggleBtn.textContent = task.done ? '–í–µ—Ä–Ω—É—Ç—å' : '–ì–æ—Ç–æ–≤–æ';
        toggleBtn.addEventListener('click', () => {
          updateTask(task.id, { done: !task.done });
        });

        const editMetaBtn = document.createElement('button');
        editMetaBtn.className = 'btn';
        editMetaBtn.type = 'button';
        editMetaBtn.textContent = '–ü—Ä–∞–≤–∫–∞';
        editMetaBtn.addEventListener('click', () => openMetaEdit(task));

        const delBtn = document.createElement('button');
        delBtn.className = 'delete-btn';
        delBtn.type = 'button';
        delBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
        delBtn.addEventListener('click', () => {
          tasks = tasks.filter(t => t.id !== task.id);
          saveTasks();
          renderTasks();
          updateProgress();
        });

        actions.appendChild(toggleBtn);
        actions.appendChild(editMetaBtn);
        actions.appendChild(delBtn);

        li.appendChild(content);
        li.appendChild(actions);
        taskList.appendChild(li);
      });

      updateProgress();
      updateControlStates();
    }

    function labelPriority(p) {
      if (p === 'low') return '–Ω–∏–∑–∫–∏–π';
      if (p === 'high') return '–≤—ã—Å–æ–∫–∏–π';
      return '—Å—Ä–µ–¥–Ω–∏–π';
    }

    function isoToday() {
      return new Date().toISOString().slice(0, 10);
    }

    function updateProgress() {
      const total = tasks.length;
      const done = tasks.filter(t => t.done).length;
      const pct = total ? Math.round((done / total) * 100) : 0;
      progressFill.style.width = pct + '%';
      progressText.textContent = `‚úÖ ${done} / ${total}`;
    }

    function updateControlStates() {
      filterButtons.forEach(b => b.classList.toggle('active', b.dataset.filter === currentFilter));
      sortButtons.forEach(b => b.classList.toggle('active', b.dataset.sort === currentSort));
      categoryFilter.classList.toggle('active', currentCategory !== 'all');
    }

    // --- –ò–Ω–ª–∞–π–Ω‚Äë—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∏—Ç—É–ª–∞ ---
    function startInlineEdit(titleEl, id) {
      if (titleEl.classList.contains('editing')) return;
      titleEl.classList.add('editing');
      const task = tasks.find(t => t.id === id);
      const inputEl = document.createElement('input');
      inputEl.type = 'text';
      inputEl.value = task.text || '';
      titleEl.textContent = '';
      titleEl.appendChild(inputEl);
      inputEl.focus();
      inputEl.select();

      const finish = (commit) => {
        titleEl.classList.remove('editing');
        if (commit) {
          const newText = inputEl.value.trim();
          if (newText) updateTask(id, { text: newText }, false);
        }
        titleEl.textContent = tasks.find(t => t.id === id).text || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)';
      };

      inputEl.addEventListener('blur', () => finish(true));
      inputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') finish(true);
        else if (e.key === 'Escape') finish(false);
      });
    }

    // --- –ü—Ä–∞–≤–∫–∞ –º–µ—Ç–∞‚Äë–¥–∞–Ω–Ω—ã—Ö (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç, –¥–µ–¥–ª–∞–π–Ω, –∫–∞—Ç–µ–≥–æ—Ä–∏—è) ---
    function openMetaEdit(task) {
      const newDeadline = prompt('–î–µ–¥–ª–∞–π–Ω (YYYY-MM-DD):', task.deadline || '');
      if (newDeadline === null) return;
      const newPriority = prompt('–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç (low/medium/high):', task.priority || 'medium');
      if (newPriority === null) return;
      const newCategory = prompt('–ö–∞—Ç–µ–≥–æ—Ä–∏—è (–£—á—ë–±–∞/–†–∞–±–æ—Ç–∞/–õ–∏—á–Ω–æ–µ):', task.category || '–õ–∏—á–Ω–æ–µ');
      if (newCategory === null) return;

      const deadline = (newDeadline || '').trim() || null;
      const priorityClean = (newPriority || '').trim();
      const categoryClean = (newCategory || '').trim();

      const priority = ['low', 'medium', 'high'].includes(priorityClean) ? priorityClean : task.priority;
      const category = ['–£—á—ë–±–∞', '–†–∞–±–æ—Ç–∞', '–õ–∏—á–Ω–æ–µ'].includes(categoryClean) ? categoryClean : task.category;

      updateTask(task.id, { deadline, priority, category });
    }

    function updateTask(id, patch, rerender = true) {
      const idx = tasks.findIndex(t => t.id === id);
      if (idx === -1) return;
      tasks[idx] = { ...tasks[idx], ...patch };
      saveTasks();
      if (rerender) {
        renderTasks();
      } else {
        updateProgress();
      }
    }

    // --- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ ---
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const text = (input.value || '').trim();
      if (!text) return;
      const deadline = dateInput.value || null;
      const priority = priorityInput.value || 'medium';
      const category = categoryInput.value || '–õ–∏—á–Ω–æ–µ';

      const task = { id: genId(), text, done: false, deadline, priority, category };
      tasks.push(task);
      saveTasks();
      input.value = '';
      dateInput.value = '';
      priorityInput.value = 'medium';
      categoryInput.value = '–õ–∏—á–Ω–æ–µ';
      renderTasks();

      // –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ, –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
      if ('Notification' in window && Notification.permission === 'granted') {
        if (deadline && deadline === isoToday()) {
          new Notification('–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è', { body: task.text });
        }
      }
    });

    // --- –§–∏–ª—å—Ç—Ä—ã –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ ---
    filterButtons.forEach(b => {
      b.addEventListener('click', () => {
        currentFilter = b.dataset.filter;
        renderTasks();
      });
    });
    categoryFilter.addEventListener('change', () => {
      currentCategory = categoryFilter.value;
      renderTasks();
    });
    sortButtons.forEach(b => {
      b.addEventListener('click', () => {
        currentSort = b.dataset.sort;
        renderTasks();
      });
    });

    // –ü–µ—Ä–≤–∏—á–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä
    renderTasks();
  </script>
</body>
</html>
